services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: healops-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - healops-postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: healops-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - healops-redis-data:/data

  backend-migrate:
    build:
      context: ./backend-coe/nestjs
      dockerfile: Dockerfile
    container_name: healops-backend-migrate
    env_file:
      - ./backend-coe/nestjs/.env
    depends_on:
      - postgres
      - redis
    command: ["node", "dist/db/drizzle/migrate.js"]
    restart: "no"

  backend-api:
    build:
      context: ./backend-coe/nestjs
      dockerfile: Dockerfile
    container_name: healops-backend-api
    env_file:
      - ./backend-coe/nestjs/.env
    depends_on:
      backend-migrate:
        condition: service_completed_successfully
    ports:
      - "3000:3000"
    command: ["node", "dist/main.js"]

  backend-worker:
    build:
      context: ./backend-coe/nestjs
      dockerfile: Dockerfile
    container_name: healops-backend-worker
    env_file:
      - ./backend-coe/nestjs/.env
    depends_on:
      backend-migrate:
        condition: service_completed_successfully
    command: ["node", "dist/worker.main.js"]

  frontend:
    build:
      context: ./frontend-coe
      dockerfile: Dockerfile
    container_name: healops-frontend
    env_file:
      - ./frontend-coe/.env
    depends_on:
      - backend-api
    ports:
      - "3001:3000"

volumes:
  healops-postgres-data:
  healops-redis-data:
